#!/bin/sh -e
#
# Activate Bluetooth on Variscite VAR-SOM-MX93
#

# Include common functions
. /etc/wifi/variscite-wireless
. /etc/gpiochip

gpio4=$(get_gpiochip "43830080.gpio")

# GPIO pin to enable BT module
BT_EN_GPIO="${gpio4} 15"

# UART device connected to BT module on VAR-SOM-MX93
BT_TTY_DEV_SOM="/dev/ttyLP4"

# IW612 ID
WIFI_SDIO_ID=0x0205

# WIFI SDIO ID file
WIFI_SDIO_ID_FILE=/sys/class/net/wlan0/device/device

# Enable BT via GPIO(s)
bt_enable()
{
	# Power up BT module
	gpioset ${BT_EN_GPIO}=0
	sleep 0.1
	gpioset ${BT_EN_GPIO}=1
	sleep 0.1
}

# Start BT hardware
bt_start()
{
	# Exit if BT module is not available
	wifi_sdio_exist ${WIFI_SDIO_ID_FILE} || exit 0

	# Exit if BT module is not iw612
	verify_sdio_id ${WIFI_SDIO_ID_FILE} ${WIFI_SDIO_ID} || exit 0

	echo "$(basename $0): starting"

	# Enable BT hardware
	bt_enable

	# Kill any running hciattach processes
	kill -9 $(pidof hciattach) 2>/dev/null || true
	sleep 0.5

	# Initialize and attach the BT device at 115200
	hciattach ${BT_TTY_DEV_SOM} any 115200 flow
	sleep 0.5
	hciconfig hci0 up
	hciconfig

	# Use hcitool to change the baud rate
	# Arguments:
	#   0x3f    : HCI_CMD_GROUP_VENDOR_SPECIFIC
	#   0x0009  : HCI_CMD_UART_BAUD
	#   0xc0 0xc6 0x2d 0x00: 3000000
	hcitool -i hci0 cmd 0x3f 0x0009 0xc0 0xc6 0x2d 0x00

	# Kill hciattach after changing the baud
	kill -9 $(pidof hciattach) 2>/dev/null || true
	sleep 0.5

	# Initialize and attach the BT device at 3000000
	hciattach ${BT_TTY_DEV_SOM} any 3000000 flow
	sleep 0.5

	# Create the flag file to indicate baud configuration completion.
	# touch $FLAG_BAUD_CONFIG
}

# Stop BT hardware
bt_stop()
{
	# Exit if BT module is not iw612
	verify_sdio_id ${WIFI_SDIO_ID_FILE} ${WIFI_SDIO_ID} || exit 0

	# Exit if BT interface is not available
	[ -e /sys/class/bluetooth/hci0 ] || exit 0

	echo "$(basename $0): stopping"

	# Bring hci0 up if it's down
	if hciconfig hci0 | grep -q "DOWN"; then
		hciconfig hci0 up
	fi

	# Use hcitool to change the baud rate
	# Arguments:
	#   0x3f    : HCI_CMD_GROUP_VENDOR_SPECIFIC
	#   0x0009  : HCI_CMD_UART_BAUD
	#   0x00 0x02 0x1C 0x00: 115200
	hcitool -i hci0 cmd 0x3f 0x0009 0x00 0xC2 0x01 0x00
	sleep 0.5

	# Kill any running hciattach processes
	kill -9 $(pidof hciattach) 2>/dev/null || true

	# Power down BT module
	gpioset ${BT_EN_GPIO}=0
}

###########################
#  Execution starts here  #
###########################
case $1 in

start)
	bt_start
	;;
stop)
	bt_stop
	;;
esac

exit 0
